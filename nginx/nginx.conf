worker_processes	1;

events {
	worker_connections	1024;
}

http {
	sendfile		on;
	include			/etc/nginx/mime.types;
	default_type	application/octet-stream;

	# Preserve original scheme when behind Traefik TLS termination
	map $http_x_forwarded_proto $forwarded_proto {
		default	$http_x_forwarded_proto;
		""		$scheme;
	}

	upstream frontend {
		server	frontend:4000;
	}

	upstream api_pong {
		server	pong_back:4001;
	}

	upstream api_users {
		server	users_back:4002;
	}

	server {
		listen	80;

		location / {
			proxy_pass			http://frontend;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}

		location /api/pong/ {
			proxy_pass			http://api_pong/;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}

		location /api/users/ {
			proxy_pass			http://api_users/;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}
	}

	# Self-signed TLS endpoint without redirecting HTTP
	server {
		listen				443 ssl;
		ssl_certificate		/etc/nginx/ssl/selfsigned.crt;
		ssl_certificate_key	/etc/nginx/ssl/selfsigned.key;

		location / {
			proxy_pass			http://frontend;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}

		location /api/pong/ {
			proxy_pass			http://api_pong/;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}

		location /api/users/ {
			proxy_pass			http://api_users/;
			proxy_set_header	Host $host;
			proxy_set_header	X-Real-IP $remote_addr;
			proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header	X-Forwarded-Proto $forwarded_proto;
		}
	}
}
